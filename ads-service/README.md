# Ads service

## Навигация

1. [Описание сервиса](#описание-сервиса)
2. [Используемые технологии](#используемые-технологии)
3. [Архитектура проекта](#архитектура-проекта)
4. [Запуск](#запуск)
5. [API](#api)
6. [Тесты](#тесты)
7. [Метрики](#метрики)

## Описание сервиса

Этот сервис, который предоставляет API для создания, хранения и выдачи объявлений.

## Используемые технологии

- GoLang - как основной язык программирования.
- PostgreSQL - БД для хранения объявлений.
- Swagger - документация API.
- Docker - контейнеризация проекта.
- Prometheus - для сбора метрик.
- Grafana - для визуализации собранных метрик.

## Архитектура проекта

1. /cmd - тут находится точка входа в приложение.
2. /config - тут находятся статические файлы конфигурации.
3. /docs - тут лежит документация swagger.
4. /logger - тут лежат настроки логгера, используемого в проекте (slog).
5. /migrations - тут лежат миграции базы данных.
6. /metrics - тут лежит инициализация метрики prometheus и график визуализации для grafana.
7. /internal - тут лежит внутренний код сервиса, который не может быть экспортирован в сторонние проекты.
    - /app - тут лежит инициализация всех модулей приложения и запуск сервера.
    - /config - тут лежит код конфиг-менеджера(viper), он подтягивает статические файлы конфигов из /config (которая находится в корне проекта).
    - /lib - тут лежат различные вспомогательные утилиты и переменные.
    - /controllers - тут лежит инициализация роутера сервиса, а также в этой папке представлен транспортный слой сервера. Тут происходит первичная обработка данных при поступлении запроса по http API.
    - /service - тут лежит внутренняя логика сервиса, которая не связана непосредственно ни с обработкой сетевых запросов, ни с взаимодействием с хранилищами данных.
    - /repository - тут лежит слой взаимодействия с базой данных.
    - /models - тут лежат модели различных сущностей в виде структур (в данном случае только сущность объявления).
8. /api - тут лежат файлы для взаимодействия с внешними сервисами, в том числе proto файлы и автоматически сгенерированные go файлы.

## Запуск

Перед тем, как запустить этот сервис, прежде нужно запустить сервис auth-service, который находится в виде git submodule этого проекта и будет лежать в корне проекта. Он так же запускается с помощью docker-compose.

Запускать проект необходимо с помощью docker-compose

```bash
docker-compose up
```

## API

http адрес сервера по умолчанию: localhost:8080

Чтобы посмотреть документацию Swagger, после запуска сервера перейдите по указанному адресу:
<http://localhost:8080/swagger/>

### Создание объявления

POST /ad/create/

Чтобы создать объявление, нужно прежде залогиниться. После, нужно передать в заголовке Authorizatin передать полученный при успешном логине jwt token в формате Bearer {token}.

Ждет на входе JSON с данными объявления. Пример json объекта:

```json
{
  "title": "title",
  "description": "description",
  "price": 1000,
  "photos": [
    "link1",
    "link2"
  ]
}
```

Валидация:

- Длина заголовка должна быть длиной от 1 до 200 символов.
- Длина описания Не должна быть более 1000 символов.
- Нельзя загрузить больше 3 ссылок на фотографии.

Создает в базе данных одно объявление.
Возвращает: ID объявления и код результата (ошибка или успех).

### Получение единичного объявления

GET /ad/{id}

Ждет указанный в URL адресе ID объявления.Возвращает: объект в формате JSON с данными объявления.

### Получение списка объявлений (постранично)

GET /ad/all/?page={pageNumber}

Ждет на входе URL параметры:

- page - Обязательный параметр, Обозначает номер страницы, каждая страница - 10 объявлений.
- price - Сортировка по цене (asc - по возрастанию, desc - по убыванию).
- date - Сортировка по дате создания (asc - по возрастанию, desc - по убыванию).
- user_id - фильтр по создаваемым определенным пользователем объявлениям.

Пример запроса:

```bash
curl "http://localhost:8080/ad/all/?page=1&price=desc"
```

Возвращает: объект в формате JSON с данными вплоть до 10 объявлений.

### Регистрация пользователя

POST /user/register/

Ждет на входе JSON с данными пользователя. Пример json объекта:

```json
{
  "email": "cat@gmail.com",
  "password": "SECRETPASSWORD123"
}
```

Возвращает id зарегистрированного пользователя

### Аутентификация пользователя

POST /user/login/

Ждет на входе JSON с данными пользователя. Пример json объекта:

```json
{
  "email": "cat@gmail.com",
  "password": "SECRETPASSWORD123"
}
```

Возвращает JSON, в котором лежит JWT токен в поле token.

## Тесты

Unit тесты написаны для всего слоя services и controllers.
Чтобы посмотреть покрытие проекта тестами, воспользуйтесь командой make:

```bash
make cover
```

## Метрики

В проекте используются метрики Prometheus, которые нужны, чтобы анализировать количество и соотношение запросов, ошибок и успешно выполненных запросов. А также Grafana, чтобы визуализизировать метрики.

Адрес Prometheus по умолчанию - localhost:9090

Адрес Grafana по умолчанию - localhost:3000

Как посмотреть графики метрик в Grafana:

  1. После запуска сервиса перейдите по адресу графаны, войдите под дефолтным логином и паролем admin/admin.
  2. Во вкладке Connections найдите Prometheus. Подключитесь, введя адрес `http://prometheus:9090/`.
  3. Перейдите в Dashboards и импортируйте график из папки проекта metrics/grafana.
